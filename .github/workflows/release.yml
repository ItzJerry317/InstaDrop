name: Build Instadrop (Win, Android, iOS)

on:
  push:
    branches: [ main ] # å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
  workflow_dispatch:   # å…è®¸ä½ åœ¨ GitHub ç½‘é¡µä¸Šæ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  # ==========================================
  # 1. ç¼–è¯‘ Windows (Electron) ç«¯
  # ==========================================
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24' # å»ºè®®ä½¿ç”¨ LTS ç‰ˆæœ¬

      - name: Install Dependencies
        run: npm install

      # æ³¨æ„ï¼šè¯·ç¡®ä¿ä½ çš„ package.json ä¸­æœ‰ build:win æˆ–ç›¸åº”çš„ electron-builder å‘½ä»¤
      - name: Build Windows App
        run: npm run build # å¦‚æœä½ æ˜¯ Viteï¼Œå…ˆç¼–è¯‘å‰ç«¯
      - name: Build Electron Executable
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --win

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Instadrop-Windows-Exe
          path: dist/*.exe # æ ¹æ®ä½  electron-builder çš„å®é™…è¾“å‡ºç›®å½•è°ƒæ•´ï¼Œé€šå¸¸æ˜¯ dist/ æˆ– release/

  # ==========================================
  # 2. ç¼–è¯‘ Android (Capacitor) ç«¯
  # ==========================================
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Setup Java (Android Require)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Install Dependencies
        run: npm install

      - name: Build Frontend (Vue)
        run: npm run build

      - name: Sync Capacitor Android
        run: npx cap sync android

      - name: Build Android APK
        working-directory: ./android
        # è¿™é‡Œé»˜è®¤æ‰“åŒ… debug ç‰ˆæœ¬ï¼Œä¸éœ€è¦å¤æ‚çš„ç­¾åé…ç½®å³å¯å®‰è£…æµ‹è¯•
        run: |
          chmod +x ./gradlew
          ./gradlew assembleDebug

      - name: Upload Android Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Instadrop-Android-APK
          path: android/app/build/outputs/apk/debug/*.apk

  # ==========================================
  # 3. ç¼–è¯‘ iOS (ä¸‡èƒ½è‡ªç­¾ç‰ˆ IPAï¼Œä»»ä½•äººå¯ç”¨ AltStore/Sideloadly å®‰è£…)
  # ==========================================
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install Dependencies
        run: npm install

      - name: Build Frontend (Vue)
        run: npm run build

      - name: Sync Capacitor iOS
        run: npx cap sync ios

      - name: Install CocoaPods dependencies
        working-directory: ./ios/App
        run: |
          cd ios/App
          pod install --repo-update

      # ğŸ”¥ æ ¸å¿ƒï¼šå¼ºåˆ¶ç¦ç”¨ Xcode çš„ç­¾åæœºåˆ¶ï¼Œç›´æ¥ç¼–è¯‘çœŸæœºç‰ˆ (iphoneos) çº¯å‡€äºŒè¿›åˆ¶ç¨‹åº
      - name: Build iOS App (Unsigned)
        working-directory: ./ios/App
        run: |
          xcodebuild clean build \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -derivedDataPath build

      # ğŸ”¥ æ‰‹åŠ¨æ‰“åŒ… IPAï¼šå»ºä¸€ä¸ª Payload æ–‡ä»¶å¤¹ï¼ŒæŠŠ App å¡è¿›å»ï¼Œå‹ç¼©ï¼Œæ”¹åï¼
      - name: Package into IPA
        working-directory: ./ios/App
        run: |
          mkdir -p Payload
          # å°†ç¼–è¯‘å¥½çš„çº¯å‡€ç‰ˆ App.app å¤åˆ¶åˆ° Payload ç›®å½•
          cp -r build/Build/Products/Release-iphoneos/App.app Payload/
          # å‹ç¼©ä¸º ipa
          zip -r Instadrop.ipa Payload

      - name: Upload Universal IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Instadrop-iOS-Universal
          path: ios/App/Instadrop.ipa