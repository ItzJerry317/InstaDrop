name: Build Instadrop (Win, Android, iOS)

on:
  push:
    branches: [ main ] # 当推送到 main 分支时自动触发
  workflow_dispatch:   # 允许你在 GitHub 网页上手动点击运行

jobs:
  # ==========================================
  # 1. 编译 Windows (Electron) 端
  # ==========================================
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24' # 建议使用 LTS 版本

      - name: Install Dependencies
        run: npm install

      # 注意：请确保你的 package.json 中有 build:win 或相应的 electron-builder 命令
      - name: Build Windows App
        run: npm run build # 如果你是 Vite，先编译前端
      - name: Build Electron Executable
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --win

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Instadrop-Windows-Exe
          path: dist/*.exe # 根据你 electron-builder 的实际输出目录调整，通常是 dist/ 或 release/

  # ==========================================
  # 2. 编译 Android (Capacitor) 端
  # ==========================================
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Setup Java (Android Require)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Install Dependencies
        run: npm install

      - name: Build Frontend (Vue)
        run: npm run build

      - name: Sync Capacitor Android
        run: npx cap sync android

      - name: Build Android APK
        working-directory: ./android
        # 这里默认打包 debug 版本，不需要复杂的签名配置即可安装测试
        run: |
          chmod +x ./gradlew
          ./gradlew assembleDebug

      - name: Upload Android Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Instadrop-Android-APK
          path: android/app/build/outputs/apk/debug/*.apk

  # ==========================================
  # 3. 编译 iOS (万能自签版 IPA，任何人可用 AltStore/Sideloadly 安装)
  # ==========================================
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install Dependencies
        run: npm install

      - name: Build Frontend (Vue)
        run: npm run build

      - name: Sync Capacitor iOS
        run: npx cap sync ios

      - name: Build iOS App (Unsigned)
        working-directory: ./ios/App
        run: |
          xcodebuild clean build \
            -project App.xcodeproj \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -derivedDataPath build

      - name: Package into IPA
        working-directory: ./ios/App
        run: |
          mkdir -p Payload
          # 将编译好的纯净版 App.app 复制到 Payload 目录
          cp -r build/Build/Products/Release-iphoneos/App.app Payload/
          # 压缩为 ipa
          zip -r Instadrop.ipa Payload

      - name: Upload Universal IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Instadrop-iOS-Universal
          path: ios/App/Instadrop.ipa
          
  # ==========================================
  # 4. 汇总打包并创建 GitHub Release 草稿
  # ==========================================
  create-release:
    needs: [build-windows, build-android, build-ios]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') 
    
    steps:
      # 1. 把前面三个 job 上传的附件全部下载到这台服务器上
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts # 下载到名为 all-artifacts 的文件夹里

      # 2. 查看一下下载的文件结构（方便你在日志里排错）
      - name: Display downloaded files
        run: ls -R all-artifacts

      # 3. 使用官方推荐的插件自动创建 Release 并附加文件
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }} # 自动提取你的 tag 名字作为标题
          draft: true
          prerelease: false
          generate_release_notes: true # 自动生成一份包含 commit 记录的更新日志
          files: |
            all-artifacts/Instadrop-Windows-Exe/*.exe
            all-artifacts/Instadrop-Android-APK/*.apk
            all-artifacts/Instadrop-iOS-Universal/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub 提供的自动授权 Token