name: Build Instadrop (Win, Android, iOS)

on:
  push:
    branches: [ main ] # å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
  workflow_dispatch:   # å…è®¸ä½ åœ¨ GitHub ç½‘é¡µä¸Šæ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  # ==========================================
  # 1. ç¼–è¯‘ Windows (Electron) ç«¯
  # ==========================================
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24' # å»ºè®®ä½¿ç”¨ LTS ç‰ˆæœ¬

      - name: Install Dependencies
        run: npm install

      # æ³¨æ„ï¼šè¯·ç¡®ä¿ä½ çš„ package.json ä¸­æœ‰ build:win æˆ–ç›¸åº”çš„ electron-builder å‘½ä»¤
      - name: Build Windows App
        run: npm run build # å¦‚æœä½ æ˜¯ Viteï¼Œå…ˆç¼–è¯‘å‰ç«¯
      - name: Build Electron Executable
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --win

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Instadrop-Windows-Exe
          path: dist/*.exe # æ ¹æ®ä½  electron-builder çš„å®é™…è¾“å‡ºç›®å½•è°ƒæ•´ï¼Œé€šå¸¸æ˜¯ dist/ æˆ– release/

  # ==========================================
  # 2. ç¼–è¯‘ Android (Capacitor) ç«¯
  # ==========================================
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Setup Java (Android Require)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Install Dependencies
        run: npm install

      - name: Build Frontend (Vue)
        run: npm run build

      - name: Sync Capacitor Android
        run: npx cap sync android

      - name: Build Android APK
        working-directory: ./android
        # è¿™é‡Œé»˜è®¤æ‰“åŒ… debug ç‰ˆæœ¬ï¼Œä¸éœ€è¦å¤æ‚çš„ç­¾åé…ç½®å³å¯å®‰è£…æµ‹è¯•
        run: |
          chmod +x ./gradlew
          ./gradlew assembleDebug

      - name: Upload Android Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Instadrop-Android-APK
          path: android/app/build/outputs/apk/debug/*.apk

  # ==========================================
  # 3. ç¼–è¯‘ iOS (ä¸‡èƒ½è‡ªç­¾ç‰ˆ IPAï¼Œä»»ä½•äººå¯ç”¨ AltStore/Sideloadly å®‰è£…)
  # ==========================================
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install Dependencies
        run: npm install

      - name: Build Frontend (Vue)
        run: npm run build

      - name: Sync Capacitor iOS
        run: npx cap sync ios

      - name: Build iOS App (Unsigned)
        working-directory: ./ios/App
        run: |
          xcodebuild clean build \
            -project App.xcodeproj \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -derivedDataPath build

      - name: Package into IPA
        working-directory: ./ios/App
        run: |
          mkdir -p Payload
          # å°†ç¼–è¯‘å¥½çš„çº¯å‡€ç‰ˆ App.app å¤åˆ¶åˆ° Payload ç›®å½•
          cp -r build/Build/Products/Release-iphoneos/App.app Payload/
          # å‹ç¼©ä¸º ipa
          zip -r Instadrop.ipa Payload

      - name: Upload Universal IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Instadrop-iOS-Universal
          path: ios/App/Instadrop.ipa
          
  # ==========================================
  # 4. æ±‡æ€»æ‰“åŒ…å¹¶åˆ›å»º GitHub Release è‰ç¨¿
  # ==========================================
  create-release:
    needs: [build-windows, build-android, build-ios]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') 
    
    steps:
      # 1. æŠŠå‰é¢ä¸‰ä¸ª job ä¸Šä¼ çš„é™„ä»¶å…¨éƒ¨ä¸‹è½½åˆ°è¿™å°æœåŠ¡å™¨ä¸Š
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts # ä¸‹è½½åˆ°åä¸º all-artifacts çš„æ–‡ä»¶å¤¹é‡Œ

      # 2. æŸ¥çœ‹ä¸€ä¸‹ä¸‹è½½çš„æ–‡ä»¶ç»“æ„ï¼ˆæ–¹ä¾¿ä½ åœ¨æ—¥å¿—é‡Œæ’é”™ï¼‰
      - name: Display downloaded files
        run: ls -R all-artifacts

      # 3. ä½¿ç”¨å®˜æ–¹æ¨èçš„æ’ä»¶è‡ªåŠ¨åˆ›å»º Release å¹¶é™„åŠ æ–‡ä»¶
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }} # è‡ªåŠ¨æå–ä½ çš„ tag åå­—ä½œä¸ºæ ‡é¢˜
          draft: true  # ğŸ”¥ ç”Ÿæˆè‰ç¨¿ (Draft)ï¼Œç­‰ä½ ç¡®è®¤æ— è¯¯åå†æ‰‹åŠ¨å‘å¸ƒ
          prerelease: false
          generate_release_notes: true # è‡ªåŠ¨ç”Ÿæˆä¸€ä»½åŒ…å« commit è®°å½•çš„æ›´æ–°æ—¥å¿—
          files: |
            # æŠŠä¸‰ä¸ªç«¯çš„æ–‡ä»¶å…¨éƒ¨å¡è¿›è¿™ä¸ª Release é‡Œ
            all-artifacts/Instadrop-Windows-Exe/*.exe
            all-artifacts/Instadrop-Android-APK/*.apk
            all-artifacts/Instadrop-iOS-Universal/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub æä¾›çš„è‡ªåŠ¨æˆæƒ Token